<!doctype html>
<html lang="da">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Vinbot ‚Äì din personlige vinassistent</title>
  <meta name="description" content="Find den perfekte vin p√• sekunder. S√∏g efter drue, land, mad eller hum√∏r ‚Äì Vinbot guider dig til de bedste k√∏b." />

  <!-- GA4 -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-JB0QD6J59G"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){ dataLayer.push(arguments); }
    gtag('js', new Date()); gtag('config', 'G-JB0QD6J59G');
  </script>

  <link rel="stylesheet" href="/assets/styles.css">
</head>
<body>
  <!-- header partial -->
  <div id="header"></div>

  <!-- HERO -->
  <header class="hero">
    <h1>Find vin p√• sekunder</h1>
    <p>Fort√¶l hvad du er i hum√∏r til ‚Äì <strong>drue</strong>, <strong>mad</strong>, <strong>pris</strong> eller <strong>lejlighed</strong>. Vinbot guider dig til de bedste butikker.</p>

    <div id="search" class="search-wrap">
      <form id="searchForm" class="search" action="#" method="get" novalidate>
        <div class="icon">üîé</div>
        <input
          id="q"
          type="search"
          placeholder="fx ‚Äúbarolo til b√∏f under 150 kr‚Äù eller ‚Äúsushi og sommer‚Äù"
          autocomplete="off"
          enterkeyhint="search"
          inputmode="search"
        />
        <button type="submit" aria-label="S√∏g" class="btn-primary">S√∏g</button>
      </form>
      <div class="search-hint">Tryk <kbd>Enter</kbd> eller brug mobilens ‚ÄúS√∏g‚Äù</div>

      <!-- Assistent-chips -->
      <div id="assistChips" class="chips">
        <!-- Type -->
        <button class="chip" data-add=" r√∏dvin">R√∏dvin</button>
        <button class="chip" data-add=" hvidvin">Hvidvin</button>
        <button class="chip" data-add=" ros√©">Ros√©</button>
        <button class="chip" data-add=" mousserende">Mousserende</button>
        <!-- Budget -->
        <button class="chip" data-add=" under 100 kr">Under 100 kr</button>
        <button class="chip" data-add=" under 150 kr">Under 150 kr</button>
        <button class="chip" data-add=" under 250 kr">Under 250 kr</button>
        <!-- Mad -->
        <button class="chip" data-add=" til pizza">Til pizza</button>
        <button class="chip" data-add=" til sushi">Til sushi</button>
        <button class="chip" data-add=" til oksek√∏d">Til oksek√∏d</button>
      </div>
    </div>
  </header>

  <!-- STATUS -->
  <div class="status"><div id="statusMsg"></div></div>

  <!-- RESULTATER -->
  <main class="wrap">
    <section class="grid" id="results" aria-live="polite"></section>
  </main>

  <!-- footer partial -->
  <div id="footer"></div>

  <!-- partial loader -->
  <script>
    (async function(){
      const [h,f] = await Promise.all([
        fetch("/partials/header.html", {cache:"no-store"}).then(r=>r.text()).catch(()=>"<nav class='nav'><a class='brand' href='/'><h1>Vinbot</h1></a></nav>"),
        fetch("/partials/footer.html", {cache:"no-store"}).then(r=>r.text()).catch(()=>"<footer class='footer'>¬© <script>document.write(new Date().getFullYear())<\/script> Vinbot.dk</footer>")
      ]);
      document.getElementById("header").innerHTML = h;
      document.getElementById("footer").innerHTML = f;
    })();
  </script>

  <!-- S√òGE-UI -->
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const $q      = document.getElementById('q');
      const $res    = document.getElementById('results');
      const $form   = document.getElementById('searchForm');
      const $status = document.getElementById('statusMsg');
      const $chips  = document.getElementById('assistChips');

      let inflight = 0;
      let triedMock = false;

      // UI helpers
      const setStatus = (html, cls="info") => { $status.innerHTML = html ? `<div class="msg ${cls}">${html}</div>` : ""; };
      const priceFmt = (v,c) => {
        try { return new Intl.NumberFormat('da-DK',{style:'currency',currency:c||'DKK',maximumFractionDigits:2}).format(v); }
        catch { return (v + ' ' + (c||'DKK')); }
      };
      const renderProducts = (items) => {
        if (!items.length){ $res.innerHTML=""; return; }
        $res.innerHTML = items.map(i => `
          <a class="card product outbound" href="${i.href}" rel="nofollow sponsored" target="_blank" data-label="${i.title} @ ${i.merchant}">
            <div class="card-media">
              ${i.image ? `<img src="${i.image}" alt="${i.title}" loading="lazy">` : `<div class="img-fallback">üç∑</div>`}
            </div>
            <div class="card-body">
              <h3>${i.title}</h3>
              <div class="badges">
                ${i.price ? `<span class="badge">${priceFmt(i.price, i.currency)}</span>` : ``}
                <span class="badge">${i.merchant}</span>
              </div>
            </div>
          </a>
        `).join('');
      };

      // API
      const fetchProducts = async (q, {mock=false}={}) => {
        const url = `/api/search?q=${encodeURIComponent(q)}${mock ? "&mock=1" : ""}`;
        const r = await fetch(url, { cache:"no-store" });
        if (!r.ok) throw new Error("API not OK");
        const data = await r.json();
        return (data.products || []).map(p => ({
          title: p.title, price: p.price, currency: p.currency || "DKK",
          image: p.image, merchant: p.merchant, href: p.url
        }));
      };

      const search = async (query) => {
        const q = (query||"").trim();
        if (!q){ renderProducts([]); setStatus(""); return; }

        const ticket = ++inflight;
        setStatus(`<span class="spinner"></span> S√∏ger efter ‚Äú${q}‚Äù‚Ä¶`, "info");
        try{
          let items = await fetchProducts(q, {mock:false});
          if ((!items || !items.length) && !triedMock){
            triedMock = true;
            const mockItems = await fetchProducts(q, {mock:true}).catch(()=>[]);
            if (mockItems.length){
              setStatus(`Ingen live-hits p√• ‚Äú${q}‚Äù. Viser demo-resultater (mock) for at bekr√¶fte at s√∏gning virker.`, "info");
              if (ticket === inflight) renderProducts(mockItems);
              return;
            }
          }
          setStatus(items.length ? "" : `Ingen resultater p√• ‚Äú${q}‚Äù. Pr√∏v fx: barolo, nebbiolo, riesling.`, "info");
          if (ticket === inflight) renderProducts(items);
        } catch (e){
          if (ticket === inflight){
            console.error(e);
            setStatus(`S√∏gningen fejlede. Tjek /api/search direkte (pr√∏v /api/search?q=barolo&mock=1).`, "err");
            renderProducts([]);
          }
        }
      };

      // events
      $form.addEventListener('submit', (e) => { e.preventDefault(); search($q.value); });
      let t=null; $q.addEventListener('input', () => { clearTimeout(t); t=setTimeout(()=>search($q.value), 300); });

      // chips
      $chips.addEventListener('click', (e)=>{
        const b = e.target.closest('.chip'); if(!b) return;
        const add = (b.dataset.add || "").trim();
        const cur = $q.value.toLowerCase();
        if (add && !cur.includes(add.toLowerCase())) {
          $q.value = ($q.value.trim() + " " + add).trim();
        }
        $form.dispatchEvent(new Event('submit', {cancelable:true}));
      });

      // GA4 outbound
      document.addEventListener('click', (e)=>{
        const a = e.target.closest('a.outbound'); if(!a) return;
        try { gtag('event','outbound_click',{event_category:'affiliate', event_label:a.dataset.label || a.href}); } catch(_){}
      });

      // init
      renderProducts([]); setStatus("");
    });
  </script>
</body>
</html>
