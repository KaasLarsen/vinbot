<!doctype html>
<html lang="da">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Vinbot â€“ find vin pÃ¥ sekunder</title>
  <meta name="description" content="Find den perfekte vin til mad, humÃ¸r eller lejlighed. Vinbot viser konkrete flasker med billeder, priser og links til de bedste butikker." />

  <!-- VIGTIGT: din korrekte CSS-sti -->
  <link rel="stylesheet" href="/assets/styles.css" />
  <link rel="icon" type="image/png" href="/assets/vinbot-logo.png" />
</head>
<body>
  <!-- Header partial mount -->
  <div id="header"></div>

  <header class="hero">
    <h1>Find vin pÃ¥ sekunder</h1>
    <p>FortÃ¦l hvad du er i humÃ¸r til â€“ <strong>drue</strong>, <strong>mad</strong>, <strong>pris</strong> eller <strong>lejlighed</strong>. Vinbot guider dig til de bedste flasker og butikker.</p>

    <div class="search-wrap">
      <div class="search">
        <div class="icon">ğŸ”</div>
        <input id="q" placeholder="fx â€œbarolo til bÃ¸f under 150 krâ€ eller â€œostâ€" autocomplete="off" autofocus
               onkeydown="if(event.key==='Enter'){doSearch()}" />
        <button class="btn-primary" id="searchBtn" onclick="doSearch()">SÃ¸g</button>
      </div>
      <p class="search-hint">Tryk <kbd>Enter</kbd> eller brug mobilens â€œSÃ¸gâ€</p>
    </div>
  </header>

  <main class="wrap">
    <section class="grid" id="results" aria-live="polite"></section>
  </main>

  <!-- Footer partial mount -->
  <div id="footer"></div>

  <script>
    // Hent header/footer partials (bevarer dit layout & styling)
    (async function loadPartials(){
      const [h,f] = await Promise.all([
        fetch("/partials/header.html", {cache:"no-store"}).then(r=>r.text()),
        fetch("/partials/footer.html", {cache:"no-store"}).then(r=>r.text())
      ]);
      document.getElementById("header").innerHTML = h;
      document.getElementById("footer").innerHTML = f;
    })();

    // -------- Intent -> vin-termer (frontend) --------
    const FOOD_TO_WINES = {
      "ost":["portvin","riesling","chardonnay","sauternes"],
      "pizza":["chianti","barbera","primitivo"],
      "bÃ¸f":["barolo","cabernet sauvignon","syrah"],
      "oksekÃ¸d":["cabernet","syrah","malbec"],
      "lam":["syrah","rioja","ribera del duero"],
      "svin":["pinot noir","riesling"],
      "fisk":["riesling","chablis","albariÃ±o"],
      "sushi":["riesling","sauvignon blanc","crÃ©mant"],
      "tapas":["rioja","garnacha","cava"],
      "dessert":["sauternes","portvin","moscato"]
    };
    const MOOD_TO_WINES = {
      "sommer":["rosÃ©","sauvignon blanc","crÃ©mant"],
      "terrasse":["rosÃ©","cava","prosecco"],
      "hygge":["primitivo","zinfandel","malbec"],
      "romantisk":["pinot noir","champagne"]
    };
    const SYN = { "shiraz":"syrah","cremant":"crÃ©mant","rose":"rosÃ©","barolo":"nebbiolo","rioja":"tempranillo","ribera":"ribera del duero" };

    function planFromText(raw){
      const q = (raw||"").toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"");
      const terms = new Set([q]);
      Object.keys(FOOD_TO_WINES).forEach(k=>{ if(q.includes(k)) FOOD_TO_WINES[k].forEach(v=>terms.add(v)); });
      Object.keys(MOOD_TO_WINES).forEach(k=>{ if(q.includes(k)) MOOD_TO_WINES[k].forEach(v=>terms.add(v)); });
      Object.keys(SYN).forEach(k=>{ if(q.includes(k)) terms.add(SYN[k]); });
      if(terms.size===1) q.split(/\s+/).forEach(t=>t&&terms.add(t));
      // Budget â€œunder 150â€, â€œmax 200â€, â€œbilligâ€
      let max=null; const m=q.match(/(?:under|max)\s*(\d{2,4})\s*kr/); if(m) max=parseInt(m[1],10);
      if(/billig|budget/.test(q)) max=Math.min(max??9999,100);
      return {terms:[...terms], max};
    }

    // -------- SÃ¸gning --------
    async function doSearch(){
      const input = document.getElementById('q');
      const query = input.value.trim();
      if(!query) return;

      const {terms, max} = planFromText(query);
      const qForApi = terms.join(" ");

      const $res = document.getElementById("results");
      $res.innerHTML = `<div class="msg info"><span class="spinner"></span> Finder flaskerâ€¦</div>`;

      try{
        const r = await fetch(`/api/search?q=${encodeURIComponent(qForApi)}${max?`&max=${max}`:""}`, {cache:"no-store"});
        const data = await r.json();
        const items = data.products || [];

        if (!items.length){
          $res.innerHTML = `<div class="msg err">Ingen resultater for â€œ${query}â€. PrÃ¸v en anden drue eller sÃ¦t et hÃ¸jere budget.</div>`;
          return;
        }

        const html = items.map(p => `
          <a class="card product outbound" href="${p.url}" target="_blank" rel="nofollow sponsored noopener" data-label="${p.title}">
            <div class="card-media">
              ${p.image ? `<img src="${p.image}" alt="${p.title}">` : `<div class="img-fallback">ğŸ·</div>`}
            </div>
            <div class="card-body">
              <h3>${p.title}</h3>
              <div class="badges">
                ${p.price!=null ? `<span class="badge">${Number(p.price).toLocaleString("da-DK",{style:"currency",currency:"DKK"})}</span>` : ""}
                ${p.merchant ? `<span class="badge">${p.merchant}</span>` : ""}
              </div>
            </div>
          </a>
        `).join("");

        $res.innerHTML = html;
      } catch(e){
        console.error(e);
        $res.innerHTML = `<div class="msg err">Der skete en fejl. PrÃ¸v igen om lidt.</div>`;
      }
    }

    // Klik-tracking (GA4 custom event hvis gtag findes)
    document.addEventListener('click', (e)=>{
      const a = e.target.closest('a.outbound'); if(!a) return;
      if (typeof gtag === 'function'){
        gtag('event','outbound_click',{event_category:'affiliate',event_label:a.dataset.label || a.href});
      }
    });
  </script>
</body>
</html>
