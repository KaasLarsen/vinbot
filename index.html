<!doctype html>
<html lang="da">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Vinbot ‚Äì din personlige vinassistent</title>
  <meta name="description" content="Find den perfekte vin p√• sekunder. S√∏g efter drue, land, mad eller hum√∏r ‚Äì Vinbot guider dig til de bedste k√∏b." />

  <!-- GA4 -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-JB0QD6J59G"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){ dataLayer.push(arguments); }
    gtag('js', new Date()); gtag('config', 'G-JB0QD6J59G');
  </script>

  <link rel="stylesheet" href="/assets/styles.css">
  <style>
    /* sm√• UI-tilf√∏jelser til loading/fejl */
    .status{max-width:1100px;margin:0 auto;padding:0 20px}
    .msg{margin:8px auto 0; padding:12px 14px; border-radius:12px; font-size:14px}
    .msg.info{background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.15); color:#efe9e0}
    .msg.err{background:rgba(255,0,0,.08); border:1px solid rgba(255,0,0,.25); color:#ffeaea}
    .spinner{display:inline-block;width:16px;height:16px;border:2px solid rgba(255,255,255,.35);border-top-color:#fff;border-radius:50%;animation:spin .6s linear infinite;vertical-align:-2px;margin-right:8px}
    @keyframes spin{to{transform:rotate(360deg)}}
  </style>
</head>
<body>

  <!-- header partial -->
  <div id="header"></div>

  <!-- HERO -->
  <header class="hero">
    <h2>Find vin p√• sekunder</h2>
    <p>Fort√¶l hvad du er i hum√∏r til ‚Äì <strong>drue</strong>, <strong>mad</strong>, <strong>pris</strong> eller <strong>lejlighed</strong>. Vinbot guider dig til de bedste butikker.</p>

    <div id="search" class="search-wrap">
      <form id="searchForm" class="search" action="#" method="get" novalidate>
        <div class="icon">üîé</div>
        <input
          id="q"
          type="search"
          placeholder="fx ‚Äúbarolo til b√∏f under 150 kr‚Äù eller ‚Äúsushi og sommer‚Äù"
          autocomplete="off"
          enterkeyhint="search"
          inputmode="search"
        />
        <button type="submit" aria-label="S√∏g" style="
          border:0;padding:10px 14px;margin-left:6px;cursor:pointer;color:#fff;
          border-radius:12px;background:linear-gradient(135deg,#e63b3b,#ff8a4c);
          box-shadow:0 10px 30px rgba(230,59,59,.35);font-weight:700;
        ">S√∏g</button>
      </form>
      <div class="search-hint">Tryk <kbd>Enter</kbd> eller brug mobilens ‚ÄúS√∏g‚Äù</div>
    </div>
  </header>

  <!-- STATUS/FEJL -->
  <div class="status"><div id="statusMsg"></div></div>

  <!-- RESULTATER -->
  <main class="wrap">
    <section class="grid" id="results" aria-live="polite"></section>
  </main>

  <!-- footer partial -->
  <div id="footer"></div>

  <!-- partial loader -->
  <script>
    (async function(){
      const [h,f] = await Promise.all([
        fetch("/partials/header.html", {cache:"no-store"}).then(r=>r.text()).catch(()=>"<nav class='nav'><a class='brand' href='/'><h1>Vinbot</h1></a></nav>"),
        fetch("/partials/footer.html", {cache:"no-store"}).then(r=>r.text()).catch(()=>"<footer>¬© <script>document.write(new Date().getFullYear())<\/script> Vinbot.dk</footer>")
      ]);
      document.getElementById("header").innerHTML = h;
      document.getElementById("footer").innerHTML = f;
    })();
  </script>

  <!-- S√òGE-UI (mobil/desktop + live + robust fallback) -->
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const $q     = document.getElementById('q');
      const $res   = document.getElementById('results');
      const $form  = document.getElementById('searchForm');
      const $status= document.getElementById('statusMsg');

      let inflight = 0;      // drop for√¶ldede svar
      let triedMock = false; // auto-selftest kun √©n gang

      // ---- UI helpers ----
      const setStatus = (html, cls="info") => { $status.innerHTML = html ? `<div class="msg ${cls}">${html}</div>` : ""; };
      const priceFmt = (v,c) => {
        try { return new Intl.NumberFormat('da-DK',{style:'currency',currency:c||'DKK',maximumFractionDigits:2}).format(v); }
        catch { return (v + ' ' + (c||'DKK')); }
      };
      const renderProducts = (items) => {
        if (!items.length){ $res.innerHTML=""; return; }
        $res.innerHTML = items.map(i => `
          <a class="card product outbound" href="${i.href}" rel="nofollow sponsored" target="_blank" data-label="${i.title} @ ${i.merchant}">
            <div style="display:flex; gap:12px; align-items:center;">
              <div style="width:64px;height:64px;border-radius:12px;overflow:hidden;background:rgba(255,255,255,.08);flex:0 0 64px;">
                ${i.image ? `<img src="${i.image}" alt="${i.title}" style="width:100%;height:100%;object-fit:cover;">` : ``}
              </div>
              <div style="flex:1;min-width:0;">
                <h3 style="margin:0 0 6px;font-size:16px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${i.title}</h3>
                <div class="badges">
                  ${i.price ? `<span class="badge">${priceFmt(i.price, i.currency)}</span>` : ``}
                  <span class="badge">${i.merchant}</span>
                </div>
              </div>
            </div>
          </a>
        `).join('');
      };

      // ---- fetch products ----
      const fetchProducts = async (q, {mock=false}={}) => {
        const url = `/api/search?q=${encodeURIComponent(q)}${mock ? "&mock=1" : ""}`;
        const r = await fetch(url, { cache:"no-store" });
        if (!r.ok) throw new Error("API not OK");
        const data = await r.json();
        return (data.products || []).map(p => ({
          title: p.title, price: p.price, currency: p.currency || "DKK",
          image: p.image, merchant: p.merchant, href: p.url
        }));
      };

      // ---- main search flow ----
      const search = async (query) => {
        const q = (query||"").trim();
        if (!q){ renderProducts([]); setStatus(""); return; }

        const ticket = ++inflight;
        setStatus(`<span class="spinner"></span> S√∏ger efter ‚Äú${q}‚Äù‚Ä¶`, "info");
        try{
          let items = await fetchProducts(q, {mock:false});
          // hvis ingen hits og vi har ikke pr√∏vet mock endnu ‚Üí lav autodemo for at tjekke UI-k√¶den
          if ((!items || !items.length) && !triedMock){
            triedMock = true;
            const mockItems = await fetchProducts(q, {mock:true}).catch(()=>[]);
            if (mockItems.length){
              setStatus(`Ingen live-hits p√• ‚Äú${q}‚Äù. Viser demo-resultater (mock) for at bekr√¶fte at s√∏gning virker.`, "info");
              if (ticket === inflight) renderProducts(mockItems);
              return;
            }
          }
          setStatus(items.length ? "" : `Ingen resultater p√• ‚Äú${q}‚Äù. Pr√∏v fx: barolo, nebbiolo, riesling.`, "info");
          if (ticket === inflight) renderProducts(items);
        } catch (e){
          console.error(e);
          if (ticket === inflight){
            setStatus(`S√∏gningen fejlede. Tjek /api/search direkte (pr√∏v /api/search?q=barolo&mock=1).`, "err");
            renderProducts([]);
          }
        }
      };

      // ---- events ----
      $form.addEventListener('submit', (e) => { e.preventDefault(); search($q.value); });
      let t=null; $q.addEventListener('input', () => { clearTimeout(t); t=setTimeout(()=>search($q.value), 300); });

      // GA4 outbound tracking
      document.addEventListener('click', (e)=>{
        const a = e.target.closest('a.outbound'); if(!a) return;
        try { gtag('event','outbound_click',{event_category:'affiliate', event_label:a.dataset.label || a.href}); } catch(_){}
      });

      // init
      renderProducts([]); setStatus("");
    });
  </script>
</body>
</html>
