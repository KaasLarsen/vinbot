<!doctype html>
<html lang="da">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Vinbot ‚Äì find vin p√• sekunder</title>
  <meta name="description" content="Find den perfekte vin til mad, hum√∏r eller lejlighed. Vinbot viser konkrete flasker med billeder, priser og links til de bedste butikker." />
  <link rel="stylesheet" href="/assets/styles.css" />
  <link rel="icon" type="image/png" href="/assets/vinbot-logo.png" />
</head>
<body>
  <div id="header"></div>

  <header class="hero">
    <h1>Find vin p√• sekunder</h1>
    <p>Fort√¶l hvad du er i hum√∏r til ‚Äì <strong>drue</strong>, <strong>mad</strong>, <strong>pris</strong> eller <strong>lejlighed</strong>. Vinbot guider dig til de bedste flasker og butikker.</p>

    <div class="search-wrap">
      <div class="search">
        <div class="icon">üîé</div>
        <input id="q" placeholder="fx ‚Äúbarolo til b√∏f under 150 kr‚Äù eller ‚Äúost og hygge‚Äù" autocomplete="off" autofocus
               onkeydown="if(event.key==='Enter'){doSearch()}" />
        <button class="btn-primary" onclick="doSearch()">S√∏g</button>
      </div>
      <p class="search-hint">Tryk <kbd>Enter</kbd> eller brug mobilens ‚ÄúS√∏g‚Äù</p>
    </div>
  </header>

  <main class="wrap">
    <div id="status" class="status"></div>
    <section class="grid" id="results" aria-live="polite"></section>
  </main>

  <div id="footer"></div>

  <script>
    // load header/footer partials
    (async()=> {
      const [h,f] = await Promise.all([
        fetch("/partials/header.html",{cache:"no-store"}).then(r=>r.text()),
        fetch("/partials/footer.html",{cache:"no-store"}).then(r=>r.text()),
      ]);
      document.getElementById("header").innerHTML = h;
      document.getElementById("footer").innerHTML = f;
    })();

    // simple intent ‚Üí vin-termer (vi kan udvide, men f√∏rst beviser vi dataflow)
    const INTENT = {
      ost:["portvin","riesling","chardonnay","sauternes"],
      pizza:["chianti","barbera","primitivo"],
      sommer:["ros√©","sauvignon blanc","cr√©mant"],
    };
    const EQUIV = {
      barolo:["nebbiolo"], nebbiolo:["barolo"],
      rioja:["tempranillo"], tempranillo:["rioja"],
      ribera:["ribera del duero","tempranillo"], "ribera del duero":["ribera","tempranillo"],
      shiraz:["syrah"], syrah:["shiraz"],
      rose:["ros√©"], "ros√©":["rose"],
      cab:["cabernet","cabernet sauvignon"], cabernet:["cab","cabernet sauvignon"], "cabernet sauvignon":["cab","cabernet"]
    };

    function deriveTerms(raw){
      const q = (raw||"").toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"");
      const S=new Set();
      Object.keys(INTENT).forEach(k=>{ if(q.includes(k)) INTENT[k].forEach(v=>S.add(v)); });
      q.split(/\s+/).forEach(t=>{ if(!t) return; S.add(t); (EQUIV[t]||[]).forEach(x=>S.add(x)); });
      let max=null; const m=q.match(/(?:under|max)\s*(\d{2,4})\s*kr/); if(m) max=parseInt(m[1],10);
      if(/billig|budget/.test(q)) max=Math.min(max??9999,100);
      return {terms:[...S], max};
    }

    async function doSearch(){
      const q = document.getElementById('q').value.trim();
      if(!q) return;
      const {terms, max} = deriveTerms(q);

      const $status = document.getElementById("status");
      const $res = document.getElementById("results");
      $status.innerHTML = `<div class="msg info"><span class="spinner"></span> S√∏ger i butikker‚Ä¶</div>`;
      $res.innerHTML = `<div class="msg info"><span class="spinner"></span> Finder flasker‚Ä¶</div>`;

      const r = await fetch(`/api/search?q=${encodeURIComponent(terms.join(" "))}${max?`&max=${max}`:""}`, {cache:"no-store"});
      const data = await r.json();

      const meta = data.meta || {};
      if (data.source === "feed") {
        const bits = [];
        bits.push(`Viser ${data.products?.length ?? 0} flasker`);
        if (meta.feeds_ok != null && meta.feeds_total != null) bits.push(`fra ${meta.feeds_ok} / ${meta.feeds_total} butikker`);
        if (meta.feeds_failed) bits.push(`(${meta.feeds_failed} fejlede)`);
        $status.innerHTML = `<div class="msg info">${bits.join(" ¬∑ ")}</div>`;
      } else if (data.source === "fallback") {
        $status.innerHTML = `<div class="msg err">Ingen direkte feed-tr√¶f. Viser butikssider uden pris.</div>`;
      } else {
        $status.innerHTML = `<div class="msg err">Ingen resultater.</div>`;
      }

      if (!data.products?.length) {
        $res.innerHTML = `<div class="msg err">Ingen rigtige produkter for ‚Äú${q}‚Äù.</div>`;
        return;
      }

      // vis ogs√• produkter uden billede (med placeholder) ‚Äì indtil feeds/OG spiller 100%
      const html = data.products.map(p => `
        <a class="card product outbound" href="${p.url}" target="_blank" rel="nofollow sponsored noopener" data-label="${p.title}">
          <div class="card-media">
            ${p.image ? `<img src="${p.image}" alt="${p.title}">` : `<div class="img-fallback">üç∑</div>`}
          </div>
          <div class="card-body">
            <h3>${p.title}</h3>
            <div class="badges">
              ${p.price!=null ? `<span class="badge">${Number(p.price).toLocaleString("da-DK",{style:"currency",currency:"DKK"})}</span>` : ""}
              ${p.merchant ? `<span class="badge">${p.merchant}</span>` : ""}
            </div>
          </div>
        </a>`).join("");

      $res.innerHTML = html;
    }
  </script>
</body>
</html>
