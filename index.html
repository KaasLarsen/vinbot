<!doctype html>
<html lang="da">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Vinbot â€“ din personlige vinassistent</title>
  <meta name="description" content="Find den perfekte vin pÃ¥ sekunder. SÃ¸g efter drue, land, mad eller humÃ¸r â€“ Vinbot guider dig til de bedste kÃ¸b." />

  <!-- Google Analytics (GA4) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-JB0QD6J59G"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){ dataLayer.push(arguments); }
    gtag('js', new Date());
    gtag('config', 'G-JB0QD6J59G');
  </script>

  <!-- Ekstern CSS -->
  <link rel="stylesheet" href="/assets/styles.css">
</head>
<body>

  <!-- header partial -->
  <div id="header"></div>

  <!-- HERO -->
  <header class="hero">
    <h2>Find vin pÃ¥ sekunder</h2>
    <p>FortÃ¦l hvad du er i humÃ¸r til â€“ <strong>drue</strong>, <strong>mad</strong>, <strong>pris</strong> eller <strong>lejlighed</strong>. Vinbot guider dig til de bedste butikker.</p>

    <div id="search" class="search-wrap">
      <div class="search">
        <div class="icon">ðŸ”Ž</div>
        <input id="q" placeholder="fx â€œbarolo til bÃ¸f under 150 krâ€ eller â€œsushi og sommerâ€" autocomplete="off" autofocus />
      </div>
      <div class="search-hint">Tryk <kbd>Enter</kbd> for forslag</div>
    </div>
  </header>

  <!-- RESULTATER -->
  <main class="wrap">
    <section class="grid" id="results" aria-live="polite"></section>
  </main>

  <!-- footer partial -->
  <div id="footer"></div>

  <!-- partial loader -->
  <script>
    (async function(){
      const [h,f] = await Promise.all([
        fetch("/partials/header.html", {cache:"no-store"}).then(r=>r.text()),
        fetch("/partials/footer.html", {cache:"no-store"}).then(r=>r.text())
      ]);
      document.getElementById("header").innerHTML = h;
      document.getElementById("footer").innerHTML = f;
    })();
  </script>

  <!-- sÃ¸gelogik -->
  <script>
    // ---- GLOBAL STATE ----
    let MERCHANTS = [];              // indlÃ¦ses fra /assets/merchants.json
    const USE_REDIRECT = false;      // sÃ¦t true nÃ¥r /out er klar
    const OUT_BASE = "/out/";        // fx "https://vinbot.dk/out/"

    // ---- MINI-ORDBÃ˜GER ----
    const MAP = {
      druer: {
        "barolo":"nebbiolo","nebbiolo":"nebbiolo","pinot noir":"pinot noir","pinot":"pinot noir",
        "chianti":"sangiovese","sangiovese":"sangiovese","primitivo":"primitivo",
        "sauvignon blanc":"sauvignon blanc","riesling":"riesling","chardonnay":"chardonnay",
        "syrah":"syrah","shiraz":"syrah","malbec":"malbec","barbera":"barbera","tempranillo":"tempranillo",
        "rioja":"tempranillo","ribera":"tempranillo","albariÃ±o":"albariÃ±o","albarino":"albariÃ±o",
        "crÃ©mant":"crÃ©mant","cremant":"crÃ©mant","rosÃ©":"rosÃ©","rose":"rosÃ©","chablis":"chardonnay"
      },
      mad: {
        "bÃ¸f":["nebbiolo","cabernet","syrah"], "oksekÃ¸d":["cabernet","syrah","barolo"],
        "pizza":["chianti","primitivo","barbera"], "tapas":["rioja","garnacha","cava"],
        "sushi":["riesling","sauvignon blanc","crÃ©mant"], "fisk":["riesling","chablis","albariÃ±o"],
        "lam":["syrah","ribera","chianti"], "ost":["riesling","portvin","chardonnay"]
      }
    };

    // ---- UTIL ----
    function parseQuery(text){
      const q = (text||"").toLowerCase();
      const out = { druer:new Set(), mad:null, max:null, mood:null, raw:q.trim() };

      Object.keys(MAP.druer).forEach(k => { if (q.includes(k)) out.druer.add(MAP.druer[k]); });
      Object.keys(MAP.mad).forEach(k => { if (q.includes(k)) out.mad = k; });

      const m = q.match(/under\s*(\d+)\s*kr|(\d+)\s*kr/);
      if (m){ const n = parseInt(m[1]||m[2],10); if (!isNaN(n)) out.max = n; }
      if (q.includes("billig") || q.includes("budget")) out.max = Math.min(out.max||9999, 100);

      if (q.includes("sommer") || q.includes("terrasse")) out.mood = "sommer";
      if (q.includes("hygge")) out.mood = "hygge";
      if (q.includes("romantisk")) out.mood = "romantisk";

      if (!out.druer.size && !out.mad && out.raw) out.druer.add(out.raw);
      return out;
    }

    function buildTarget(merchant, keyword){
      // merchant.search forventes at indeholde {Q} som placeholder
      const target = merchant.search.includes("{Q}")
        ? merchant.search.replace("{Q}", encodeURIComponent(keyword))
        : merchant.search;
      if (!USE_REDIRECT) return target;

      const u = new URL(OUT_BASE, location.origin);
      u.searchParams.set("to", target);
      u.searchParams.set("subid", "search-"+Date.now());
      return u.toString();
    }

    function createIdeas(text){
      if (!MERCHANTS.length) return [];
      const f = parseQuery(text);
      const keys = [];
      if (f.mad && MAP.mad[f.mad]) keys.push(...MAP.mad[f.mad].slice(0,2));
      if (f.druer.size) keys.push(...Array.from(f.druer).slice(0,2));
      if (!keys.length && f.raw) keys.push(f.raw);

      // sortÃ©r let efter kommission (hÃ¸jere fÃ¸rst) â€“ tiebreaker for synlighed
      const merchants = [...MERCHANTS].sort((a,b)=> (b.commission||0)-(a.commission||0));

      const ideas = [];
      for (const kw of keys){
        for (const m of merchants){
          ideas.push({
            title: `${kw} hos ${m.name}`,
            href: buildTarget(m, kw),
            badges: [
              f.mad?`Mad: ${f.mad}`:null,
              f.max?`Under ${f.max} kr`:null,
              f.mood?`${f.mood}`:null,
              m.commission?`${m.commission}%`:null
            ].filter(Boolean)
          });
        }
      }
      return ideas.slice(0, 12);
    }

    // ---- RENDER ----
    const $q = document.getElementById('q');
    const $res = document.getElementById('results');

    function render(items){
      if (!items.length) { $res.innerHTML = ""; return; }
      $res.innerHTML = items.map(i => `
        <a class="card outbound" href="${i.href}" rel="nofollow sponsored" target="_blank" data-label="${i.title}">
          <h3>${i.title}</h3>
          <div class="badges">${i.badges.map(b=>`<span class="badge">${b}</span>`).join('')}</div>
        </a>
      `).join('');
    }

    function update(){ render(createIdeas($q.value)); }

    $q.addEventListener('keydown', e => { if (e.key === 'Enter') update(); });

    // GA4: track outbound
    document.addEventListener('click', (e)=>{
      const a = e.target.closest('a.outbound'); if(!a) return;
      try { gtag('event','outbound_click',{event_category:'affiliate', event_label:a.dataset.label||a.href}); } catch(_){}
    });

    // ---- LOAD MERCHANTS ----
    (async function loadMerchants(){
      try{
        const res = await fetch("/assets/merchants.json", {cache:"no-store"});
        MERCHANTS = await res.json();
      } catch(err){
        console.error("Kunne ikke loade merchants.json", err);
        MERCHANTS = [];
      } finally {
        // kÃ¸r en initial render (tom, indtil bruger trykker Enter)
        render([]);
      }
    })();
  </script>
</body>
</html>
