<!doctype html>
<html lang="da">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Vinbot ‚Äì find vin p√• sekunder</title>
  <meta name="description" content="Find den perfekte vin til mad, hum√∏r eller lejlighed. Vinbot viser konkrete flasker med billeder, priser og links til de bedste butikker." />
  <link rel="stylesheet" href="/assets/styles.css" />
  <link rel="icon" type="image/png" href="/assets/vinbot-logo.png" />
</head>
<body>
  <!-- Header partial mount -->
  <div id="header"></div>

  <header class="hero">
    <h1>Find vin p√• sekunder</h1>
    <p>Fort√¶l hvad du er i hum√∏r til ‚Äì <strong>drue</strong>, <strong>mad</strong>, <strong>pris</strong> eller <strong>lejlighed</strong>. Vinbot guider dig til de bedste flasker og butikker.</p>

    <div class="search-wrap">
      <div class="search">
        <div class="icon">üîé</div>
        <input id="q" placeholder="fx ‚Äúbarolo til b√∏f under 150 kr‚Äù eller ‚Äúost og hygge‚Äù" autocomplete="off" autofocus onkeydown="if(event.key==='Enter'){doSearch()}" />
        <button class="btn-primary" id="searchBtn" onclick="doSearch()">S√∏g</button>
      </div>
      <p class="search-hint">Tryk <kbd>Enter</kbd> eller brug mobilens ‚ÄúS√∏g‚Äù</p>
    </div>
  </header>

  <main class="wrap">
    <!-- STATUSBAR -->
    <div id="status" class="status"></div>

    <section class="grid" id="results" aria-live="polite"></section>
  </main>

  <!-- Footer partial mount -->
  <div id="footer"></div>

  <script>
    // Hent header/footer partials (bevarer dit layout & styling)
    (async function loadPartials(){
      const [h,f] = await Promise.all([
        fetch("/partials/header.html", {cache:"no-store"}).then(r=>r.text()),
        fetch("/partials/footer.html", {cache:"no-store"}).then(r=>r.text())
      ]);
      document.getElementById("header").innerHTML = h;
      document.getElementById("footer").innerHTML = f;
    })();
  </script>

  <script>
  // === Intent -> VIN-TERMER ===
  const FOOD_TO_WINES = {
    ost:["portvin","riesling","chardonnay","sauternes"],
    pizza:["chianti","barbera","primitivo"],
    b√∏f:["barolo","cabernet sauvignon","syrah"],
    oksek√∏d:["cabernet","syrah","malbec"],
    lam:["syrah","rioja","ribera del duero"],
    svin:["pinot noir","riesling"],
    fisk:["riesling","chablis","albari√±o"],
    sushi:["riesling","sauvignon blanc","cr√©mant"],
    tapas:["rioja","garnacha","cava"],
    dessert:["sauternes","portvin","moscato"]
  };
  const MOOD_TO_WINES = {
    sommer:["ros√©","sauvignon blanc","cr√©mant"],
    terrasse:["ros√©","cava","prosecco"],
    hygge:["primitivo","zinfandel","malbec"],
    romantisk:["pinot noir","champagne"]
  };
  const SYNONYMS = { shiraz:"syrah", cremant:"cr√©mant", rose:"ros√©", barolo:"nebbiolo", rioja:"tempranillo", ribera:"ribera del duero" };

  function deriveSearchTerms(raw){
    const q = (raw||"").toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"");
    let mapped = new Set();

    Object.keys(FOOD_TO_WINES).forEach(k => { if (q.includes(k)) FOOD_TO_WINES[k].forEach(v => mapped.add(v)); });
    Object.keys(MOOD_TO_WINES).forEach(k => { if (q.includes(k)) MOOD_TO_WINES[k].forEach(v => mapped.add(v)); });
    Object.keys(SYNONYMS).forEach(k => { if (q.includes(k)) mapped.add(SYNONYMS[k]); });

    // Budget
    let max = null;
    const m = q.match(/(?:under|max)\s*(\d{2,4})\s*kr/);
    if (m) max = parseInt(m[1], 10);
    if (/billig|budget/.test(q)) max = Math.min(max ?? 9999, 100);

    // Hvis vi fandt vin-termer, S√Ö BRUG KUN DEM. Ellers brug tokens fra q.
    const terms = mapped.size ? Array.from(mapped) : q.split(/\s+/).filter(Boolean);
    return { terms, max };
  }

  // === S√òGNING MED STATUSBAR ===
  async function doSearch(){
    const qInput = document.getElementById('q').value.trim();
    if (!qInput) return;

    const { terms, max } = deriveSearchTerms(qInput);
    const qForApi = terms.join(" ");

    const $res = document.getElementById("results");
    const $status = document.getElementById("status");

    $status.innerHTML = `<div class="msg info"><span class="spinner"></span> S√∏ger i butikker‚Ä¶</div>`;
    $res.innerHTML = `<div class="msg info"><span class="spinner"></span> Finder flasker‚Ä¶</div>`;

    try {
      const r = await fetch(`/api/search?q=${encodeURIComponent(qForApi)}${max?`&max=${max}`:""}`, { cache: "no-store" });
      const data = await r.json();

      // STATUS
      const mt = data.meta || {};
      if (data.source && /feed/.test(data.source)) {
        const ok = mt.feeds_ok ?? null, tot = mt.feeds_total ?? null, fail = mt.feeds_failed ?? null;
        const bits = [];
        bits.push(`Viser ${data.products?.length ?? 0} flasker`);
        if (ok != null && tot != null) bits.push(`fra ${ok} ud af ${tot} butikker`);
        if (fail) bits.push(`(${fail} fejlede)`);
        $status.innerHTML = `<div class="msg info">${bits.join(" ¬∑ ")}</div>`;
      } else if (data.source === "fallback") {
        $status.innerHTML = `<div class="msg err">Ingen direkte feed-tr√¶f p√• ‚Äú${qInput}‚Äù. Viser butikssider uden pris.</div>`;
      } else {
        $status.innerHTML = `<div class="msg err">Ingen resultater for ‚Äú${qInput}‚Äù. Pr√∏v en drue (fx ‚Äúriesling‚Äù) eller just√©r budget.</div>`;
      }

      // VIS KUN √ÜGTE PRODUKTER (skjul fallback-kort)
      if (!data.products?.length || (data.source && !/feed/.test(data.source))) {
        $res.innerHTML = `<div class="msg err">Ingen rigtige produkt-tr√¶f endnu for ‚Äú${qInput}‚Äù.</div>`;
        return;
      }

      const html = data.products
        .filter(p => p.image && p.url)
        .map(p => `
          <a class="card product outbound" href="${p.url}" target="_blank" rel="nofollow sponsored noopener" data-label="${p.title}">
            <div class="card-media"><img src="${p.image}" alt="${p.title}"></div>
            <div class="card-body">
              <h3>${p.title}</h3>
              <div class="badges">
                ${p.price!=null ? `<span class="badge">${Number(p.price).toLocaleString("da-DK",{style:"currency",currency:"DKK"})}</span>` : ""}
                ${p.merchant ? `<span class="badge">${p.merchant}</span>` : ""}
              </div>
            </div>
          </a>
        `).join("");

      $res.innerHTML = html || `<div class="msg err">Ingen rigtige flasker fundet for ‚Äú${qInput}‚Äù.</div>`;
    } catch (err) {
      console.error(err);
      document.getElementById("status").innerHTML = `<div class="msg err">Teknisk fejl ‚Äì pr√∏v igen om lidt.</div>`;
      document.getElementById("results").innerHTML = `<div class="msg err">Kunne ikke hente resultater.</div>`;
    }
  }

  // GA4 outbound tracking (valgfrit)
  document.addEventListener('click', (e)=>{
    const a = e.target.closest('a.outbound'); if(!a) return;
    if (typeof gtag === 'function'){
      gtag('event','outbound_click',{event_category:'affiliate',event_label:a.dataset.label || a.href});
    }
  });
  </script>
</body>
</html>
