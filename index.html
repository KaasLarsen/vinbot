<!doctype html>
<html lang="da">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Vinbot ‚Äì din personlige vinassistent</title>
  <meta name="description" content="Find den perfekte vin p√• sekunder. S√∏g efter drue, mad, pris eller lejlighed." />
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-JB0QD6J59G"></script>
  <script>
    window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}
    gtag('js',new Date()); gtag('config','G-JB0QD6J59G');
  </script>
  <link rel="stylesheet" href="/assets/styles.css">
</head>
<body>
  <div id="header"></div>

  <header class="hero">
    <h1>Find vin p√• sekunder</h1>
    <p>Fort√¶l hvad du er i hum√∏r til ‚Äì <strong>drue</strong>, <strong>mad</strong>, <strong>pris</strong> eller <strong>lejlighed</strong>. Vinbot guider dig til de bedste butikker.</p>

    <div class="search-wrap">
      <form id="searchForm" class="search" action="#" method="get" novalidate>
        <div class="icon">üîé</div>
        <input id="q" type="search" placeholder="fx ‚Äúbarolo til b√∏f under 150 kr‚Äù eller ‚Äúsushi og sommer‚Äù" autocomplete="off" enterkeyhint="search" inputmode="search" />
        <button type="submit" class="btn-primary">S√∏g</button>
      </form>
      <div class="search-hint">Tryk <kbd>Enter</kbd> eller brug mobilens ‚ÄúS√∏g‚Äù</div>
    </div>
  </header>

  <!-- Dialog-boks (AI-agtig opf√∏lgning) -->
  <section id="followup" class="followup hidden">
    <div class="followup-inner">
      <h2>Lad mig lige finpudse matchene</h2>
      <form id="followForm" class="follow-grid">
        <label>Type
          <select id="f_type">
            <option value="">Ingen pr√¶ference</option>
            <option>r√∏dvin</option><option>hvidvin</option><option>ros√©</option><option>mousserende</option>
          </select>
        </label>
        <label>Budget (max)
          <select id="f_budget">
            <option value="">Intet max</option>
            <option>under 100 kr</option>
            <option>under 150 kr</option>
            <option>under 250 kr</option>
            <option>under 400 kr</option>
          </select>
        </label>
        <label>Til maden?
          <select id="f_food">
            <option value="">Ingen</option>
            <option>til pizza</option><option>til sushi</option><option>til oksek√∏d</option>
            <option>til tapas</option><option>til ost</option>
          </select>
        </label>
        <button class="btn-primary" type="submit">Opdater forslag</button>
      </form>
    </div>
  </section>

  <div class="status"><div id="statusMsg"></div></div>

  <main class="wrap">
    <section class="grid" id="results" aria-live="polite"></section>
  </main>

  <div id="footer"></div>

  <script>
    (async function(){
      const [h,f] = await Promise.all([
        fetch("/partials/header.html",{cache:"no-store"}).then(r=>r.text()).catch(()=>"<nav class='nav'><a class='brand' href='/'><h1>Vinbot</h1></a></nav>"),
        fetch("/partials/footer.html",{cache:"no-store"}).then(r=>r.text()).catch(()=>"<footer class='footer'>¬© <script>document.write(new Date().getFullYear())<\/script> Vinbot.dk</footer>")
      ]);
      document.getElementById('header').innerHTML = h;
      document.getElementById('footer').innerHTML = f;
    })();
  </script>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const $q = document.getElementById('q');
      const $form = document.getElementById('searchForm');
      const $res = document.getElementById('results');
      const $status = document.getElementById('statusMsg');
      const $follow = document.getElementById('followup');
      const $followForm = document.getElementById('followForm');

      let inflight = 0;
      const setStatus = (html, cls="info") => { $status.innerHTML = html ? `<div class="msg ${cls}">${html}</div>` : ""; };
      const priceFmt = (v,c) => { try { return new Intl.NumberFormat('da-DK',{style:'currency',currency:c||'DKK'}).format(v); } catch { return v+(c?' '+c:''); } };
      const render = (items) => {
        if (!items.length){ $res.innerHTML=""; return; }
        $res.innerHTML = items.map(i=>`
          <a class="card product outbound" href="${i.href}" rel="nofollow sponsored" target="_blank" data-label="${i.title} @ ${i.merchant}">
            <div class="card-media">${i.image?`<img src="${i.image}" alt="${i.title}" loading="lazy">`:`<div class="img-fallback">üç∑</div>`}</div>
            <div class="card-body">
              <h3>${i.title}</h3>
              <div class="badges">
                ${i.price?`<span class="badge">${priceFmt(i.price,i.currency)}</span>`:""}
                <span class="badge">${i.merchant}</span>
              </div>
            </div>
          </a>`).join('');
      };

      async function fetchProducts(q){
        const r = await fetch(`/api/search?q=${encodeURIComponent(q)}`,{cache:"no-store"});
        if (!r.ok) throw new Error("API not OK");
        const data = await r.json();
        return (data.products||[]).map(p=>({ title:p.title, price:p.price, currency:p.currency||"DKK", image:p.image, merchant:p.merchant, href:p.url }));
      }

      async function search(query){
        const q = (query||"").trim();
        if (!q){ render([]); setStatus(""); return; }
        const ticket = ++inflight;
        setStatus(`<span class="spinner"></span> S√∏ger efter ‚Äú${q}‚Äù‚Ä¶`);
        try{
          const items = await fetchProducts(q);
          if (ticket !== inflight) return;
          render(items);
          setStatus(items.length?"":"Ingen resultater. Pr√∏v at pr√¶cisere ‚Äì brug boksen nedenfor.");
          // Vis follow-up boksen hvis f√• resultater
          $follow.classList.toggle('hidden', items.length >= 6);
        } catch(e){
          if (ticket !== inflight) return;
          setStatus("S√∏gningen fejlede. Pr√∏v igen.", "err");
          render([]); $follow.classList.remove('hidden');
        }
      }

      $form.addEventListener('submit', (e)=>{ e.preventDefault(); search($q.value); });
      let t=null; $q.addEventListener('input', ()=>{ clearTimeout(t); t=setTimeout(()=>search($q.value), 300); });

      // Follow-up: bygger ny s√∏gning ud fra brugerens valg
      $followForm.addEventListener('submit', (e)=>{
        e.preventDefault();
        const type = document.getElementById('f_type').value;
        const budget = document.getElementById('f_budget').value;
        const food = document.getElementById('f_food').value;
        const parts = [$q.value.trim(), type, budget, food].filter(Boolean);
        const newQ = parts.join(' ').replace(/\s+/g,' ').trim();
        $q.value = newQ;
        search(newQ);
      });

      // GA4 outbound
      document.addEventListener('click', (e)=>{
        const a=e.target.closest('a.outbound'); if(!a) return;
        try{ gtag('event','outbound_click',{event_category:'affiliate', event_label:a.dataset.label||a.href}); }catch(_){}
      });

      render([]); setStatus("");
    });
  </script>
</body>
</html>
