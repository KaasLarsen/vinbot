<!doctype html>
<html lang="da">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Vinbot â€“ din personlige vinassistent</title>
  <meta name="description" content="Find den perfekte vin pÃ¥ sekunder. SÃ¸g efter drue, land, mad eller humÃ¸r â€“ Vinbot guider dig til de bedste kÃ¸b." />

  <!-- Google Analytics (GA4) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-JB0QD6J59G"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){ dataLayer.push(arguments); }
    gtag('js', new Date());
    gtag('config', 'G-JB0QD6J59G');
  </script>

  <!-- Ekstern CSS -->
  <link rel="stylesheet" href="/assets/styles.css">
</head>
<body>

  <!-- header partial -->
  <div id="header"></div>

  <!-- HERO -->
  <header class="hero">
    <h2>Find vin pÃ¥ sekunder</h2>
    <p>FortÃ¦l hvad du er i humÃ¸r til â€“ <strong>drue</strong>, <strong>mad</strong>, <strong>pris</strong> eller <strong>lejlighed</strong>. Vinbot guider dig til de bedste butikker.</p>

    <div id="search" class="search-wrap">
      <form id="searchForm" class="search">
        <div class="icon">ğŸ”</div>
        <input
          id="q"
          type="search"
          placeholder="fx â€œbarolo til bÃ¸f under 150 krâ€ eller â€œsushi og sommerâ€"
          autocomplete="off"
          autofocus
          enterkeyhint="search"
          inputmode="search"
        />
        <button type="submit" style="display:none"></button>
      </form>
      <div class="search-hint">Tryk <kbd>Enter</kbd> eller brug mobilens â€œSÃ¸gâ€</div>
    </div>
  </header>

  <!-- RESULTATER -->
  <main class="wrap">
    <section class="grid" id="results" aria-live="polite"></section>
  </main>

  <!-- footer partial -->
  <div id="footer"></div>

  <!-- partial loader -->
  <script>
    (async function(){
      const [h,f] = await Promise.all([
        fetch("/partials/header.html", {cache:"no-store"}).then(r=>r.text()),
        fetch("/partials/footer.html", {cache:"no-store"}).then(r=>r.text())
      ]);
      document.getElementById("header").innerHTML = h;
      document.getElementById("footer").innerHTML = f;
    })();
  </script>

  <!-- SÃ˜GE-UI (V1 feed-baseret + mobil-fix) -->
  <script>
    const $q = document.getElementById('q');
    const $res = document.getElementById('results');
    const $form = document.getElementById('searchForm');

    // mobil + desktop: submit trigger sÃ¸gning
    $form.addEventListener('submit', (e) => {
      e.preventDefault();
      update();
    });

    // desktop fallback
    $q.addEventListener('keydown', e => { if (e.key === 'Enter') update(); });

    async function update(){
      const q = $q.value.trim();
      if (!q) { renderProducts([]); return; }

      try{
        const r = await fetch(`/api/search?q=${encodeURIComponent(q)}`, { cache: "no-store" });
        const data = await r.json();
        const items = (data.products || []).map(p => ({
          title: p.title,
          price: p.price,
          currency: p.currency || "DKK",
          image: p.image,
          merchant: p.merchant,
          href: p.url // (kan routes via /out senere)
        }));
        renderProducts(items);
      } catch (e){
        console.error("Search failed", e);
        renderProducts([]);
      }
    }

    function renderProducts(items){
      if (!items.length) { $res.innerHTML = ""; return; }
      $res.innerHTML = items.map(i => `
        <a class="card product outbound" href="${i.href}" rel="nofollow sponsored" target="_blank" data-label="${i.title} @ ${i.merchant}">
          <div style="display:flex; gap:12px; align-items:center;">
            <div style="width:64px;height:64px;border-radius:12px;overflow:hidden;background:rgba(255,255,255,.08);flex:0 0 64px;">
              ${i.image ? `<img src="${i.image}" alt="${i.title}" style="width:100%;height:100%;object-fit:cover;">` : ``}
            </div>
            <div style="flex:1;min-width:0;">
              <h3 style="margin:0 0 6px;font-size:16px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${i.title}</h3>
              <div class="badges">
                ${i.price ? `<span class="badge">${formatPrice(i.price, i.currency)}</span>` : ``}
                <span class="badge">${i.merchant}</span>
              </div>
            </div>
          </div>
        </a>
      `).join('');
    }

    function formatPrice(v, c){
      try {
        return new Intl.NumberFormat('da-DK', { style:'currency', currency: c || 'DKK', maximumFractionDigits: 2 }).format(v);
      } catch { return (v + ' ' + (c||'DKK')); }
    }

    // GA4: track outbound klik
    document.addEventListener('click', (e)=>{
      const a = e.target.closest('a.outbound'); if(!a) return;
      try { gtag('event','outbound_click',{event_category:'affiliate', event_label:a.dataset.label || a.href}); } catch(_){}
    });

    // init â€“ tomt ved start
    renderProducts([]);
  </script>
</body>
</html>
